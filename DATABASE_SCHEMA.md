# DataVision Database Schema

This document details what data is stored in the MongoDB database for the DataVision application.

## Database Collections

The database contains **2 main collections**:

1. **Users** - User account information
2. **Reports** - User-generated data analysis reports

---

## 1. Users Collection

### Purpose
Stores user account information for authentication and user management.

### Schema Structure

```javascript
{
  _id: ObjectId,                    // Auto-generated by MongoDB
  name: String,                     // User's full name (max 50 characters)
  email: String,                    // User's email (unique, indexed, lowercase)
  password: String,                 // Hashed password (bcrypt, not selectable by default)
  createdAt: Date,                  // Account creation timestamp
  updatedAt: Date                   // Last update timestamp
}
```

### Example Document

```json
{
  "_id": "507f1f77bcf86cd799439011",
  "name": "John Doe",
  "email": "john@example.com",
  "password": "$2a$10$abcdefghijklmnopqrstuvwxyz1234567890",
  "createdAt": "2024-01-15T10:30:00.000Z",
  "updatedAt": "2024-01-15T10:30:00.000Z"
}
```

### Fields Details

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | String | Yes | User's display name, trimmed, max 50 chars |
| `email` | String | Yes | Unique email address, lowercase, validated format |
| `password` | String | Yes | Bcrypt hashed password (10 rounds), min 6 chars |
| `createdAt` | Date | Auto | Automatically set on creation |
| `updatedAt` | Date | Auto | Automatically updated on modification |

### Security Notes
- **Password**: Stored as bcrypt hash (never plain text)
- **Password Field**: Excluded from queries by default (`select: false`)
- **Email**: Unique index prevents duplicate accounts

---

## 2. Reports Collection

### Purpose
Stores complete data analysis reports including parsed file data, AI insights, and chart configurations.

### Schema Structure

```javascript
{
  _id: ObjectId,                    // Auto-generated by MongoDB
  userId: ObjectId,                 // Reference to User (indexed)
  title: String,                    // Report title
  fileName: String,                 // Original uploaded file name
  fileType: String,                 // File extension (xlsx, xls, csv, pdf, docx)
  data: Object,                     // Parsed and normalized file data
  insights: {
    summary: String,                // AI-generated summary
    trends: [String],               // Array of detected trends
    anomalies: [String],            // Array of detected anomalies
    recommendations: [String]       // Array of recommendations
  },
  charts: [{
    type: String,                   // Chart type (bar, line, pie, area, radar)
    data: Object,                   // Chart data points
    config: Object                  // Chart configuration (optional)
  }],
  createdAt: Date,                  // Report creation timestamp
  updatedAt: Date                   // Last update timestamp
}
```

### Example Document

```json
{
  "_id": "507f191e810c19729de860ea",
  "userId": "507f1f77bcf86cd799439011",
  "title": "Sales Data Analysis Q1 2024",
  "fileName": "sales_q1_2024.xlsx",
  "fileType": "xlsx",
  "data": {
    "columns": ["Month", "Sales", "Revenue"],
    "rows": [
      ["January", "150", "15000"],
      ["February", "200", "20000"],
      ["March", "180", "18000"]
    ],
    "metadata": {
      "fileName": "sales_q1_2024.xlsx",
      "fileType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
      "rowCount": 3,
      "columnCount": 3
    }
  },
  "insights": {
    "summary": "This report analyzes sales data showing an overall upward trend...",
    "trends": [
      "Sales shows an upward trend (33.3% increase from January to March).",
      "Revenue shows an upward trend (33.3% increase from January to March)."
    ],
    "anomalies": [
      "Anomaly detected in Sales at row 3: 180 (expected range: 150 - 200)."
    ],
    "recommendations": [
      "Multiple numeric columns found. Consider creating correlation analysis.",
      "Trends detected. Consider implementing time-series analysis."
    ]
  },
  "charts": [
    {
      "type": "bar",
      "data": [
        { "Month": "January", "Sales": 150 },
        { "Month": "February", "Sales": 200 },
        { "Month": "March", "Sales": 180 }
      ],
      "config": {}
    }
  ],
  "createdAt": "2024-01-20T14:30:00.000Z",
  "updatedAt": "2024-01-20T14:30:00.000Z"
}
```

### Fields Details

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `userId` | ObjectId | Yes | Reference to User collection (indexed for fast queries) |
| `title` | String | Yes | User-defined report title |
| `fileName` | String | Yes | Original uploaded file name |
| `fileType` | String | Yes | File extension: `xlsx`, `xls`, `csv`, `pdf`, or `docx` |
| `data` | Object | Yes | Complete parsed file data (see Data Structure below) |
| `insights.summary` | String | Yes | AI-generated executive summary |
| `insights.trends` | Array[String] | Yes | List of detected trends in the data |
| `insights.anomalies` | Array[String] | Yes | List of detected anomalies |
| `insights.recommendations` | Array[String] | Yes | List of recommendations |
| `charts` | Array[Object] | No | Array of chart configurations (see Charts Structure) |
| `createdAt` | Date | Auto | Report creation timestamp |
| `updatedAt` | Date | Auto | Last update timestamp |

### Data Structure (inside `data` field)

```javascript
{
  columns: String[],           // Array of column names from file
  rows: Array[],              // Array of row arrays (each row is an array of cell values)
  metadata: {
    fileName: String,         // Original file name
    fileType: String,         // MIME type or file extension
    rowCount: Number,         // Number of data rows
    columnCount: Number       // Number of columns
  }
}
```

### Charts Structure (inside `charts` array)

```javascript
{
  type: String,               // One of: 'bar', 'line', 'pie', 'area', 'radar'
  data: Object,               // Chart data points (format varies by chart type)
  config: Object              // Optional chart configuration (colors, labels, etc.)
}
```

### Indexes

- **Compound Index**: `{ userId: 1, createdAt: -1 }`
  - Purpose: Fast retrieval of user's reports ordered by creation date
  - Used for: Dashboard report listing

---

## Data Flow: When a User Uploads a File

### Step 1: File Upload
- User uploads file through dashboard
- **File is NOT stored in database** (only parsed client-side)

### Step 2: File Parsing
- File is parsed client-side using appropriate parser (SheetJS, pdf-parse, etc.)
- Creates `ParsedData` object with:
  - `columns`: Column names
  - `rows`: Data rows
  - `metadata`: File information

### Step 3: Insights Generation
- AI insights engine analyzes parsed data
- Generates:
  - Summary
  - Trends
  - Anomalies
  - Recommendations

### Step 4: Chart Creation
- User selects chart type and columns
- Chart data is prepared

### Step 5: Report Saving (Optional)
- When user clicks "Save Report", the following is stored:
  - **Parsed data** (complete file contents)
  - **Generated insights**
  - **Chart configurations**
  - **User reference**
  - **Metadata** (title, filename, etc.)

---

## What is NOT Stored

The following are **NOT** stored in the database:

1. **Original Uploaded Files**
   - Files are parsed client-side and never uploaded to server
   - Only parsed data structure is stored

2. **Session Data**
   - JWT tokens are stored in HTTP-only cookies (not in database)
   - Session data managed by NextAuth.js in cookies

3. **Temporary Analysis**
   - If user doesn't save report, nothing is stored
   - Only explicitly saved reports are persisted

4. **Exported Files**
   - Exported PDFs/DOCX/PNG files are generated on-demand
   - Not stored in database

---

## Database Size Considerations

### Storage Size per Report

Approximate sizes:
- **User Document**: ~500 bytes
- **Report Document**: Varies by file size
  - Small file (100 rows, 5 columns): ~10-20 KB
  - Medium file (1000 rows, 10 columns): ~100-200 KB
  - Large file (10000 rows, 20 columns): ~1-2 MB

### Optimization Tips

1. **Large Datasets**: Consider storing only summary/aggregated data for very large files
2. **Chart Data**: Only store chart data that user actually created
3. **File Metadata**: Store minimal metadata to reduce document size
4. **Cleanup**: Implement report deletion to manage database growth

---

## Privacy & Security

### Data Ownership
- Each report is linked to a specific user (`userId`)
- Users can only access their own reports
- Reports are isolated by user

### Data Encryption
- **Passwords**: Encrypted with bcrypt (10 rounds)
- **Database**: Consider MongoDB encryption at rest for production
- **Transmission**: Use HTTPS/TLS for data in transit

### Data Retention
- Reports persist until user deletes them
- No automatic cleanup (implement as needed)

---

## Query Examples

### Get All Reports for a User
```javascript
db.reports.find({ userId: ObjectId("...") })
  .sort({ createdAt: -1 })
  .limit(50)
```

### Get User by Email
```javascript
db.users.findOne({ email: "user@example.com" })
```

### Count Reports per User
```javascript
db.reports.aggregate([
  { $group: { _id: "$userId", count: { $sum: 1 } } }
])
```

---

## Migration Notes

If you need to modify the schema:

1. **Adding Fields**: New fields can be added without migration (MongoDB is schema-less)
2. **Removing Fields**: Use updateMany to clean up
3. **Changing Types**: May require migration script
4. **Indexes**: Add/remove indexes as needed without affecting data

---

This schema supports the core functionality of DataVision while maintaining user data isolation and efficient querying.
